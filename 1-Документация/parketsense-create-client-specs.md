# PARKETSENSE - Спецификация за създаване на клиент

## Use Cases и сценарии

### UC1: Създаване на физическо лице

**Стъпки:**
1. Потребителят избира "Физическо лице"
2. Въвежда име и фамилия (задължителни)
3. Въвежда телефон (задължителен, уникален)
4. Опционално: email, адрес, бележки
5. Опционално: маркира като архитект и задава комисионна
6. Добавя до 2 допълнителни контактни лица
7. Преглежда и запазва

**Валидации:**
- Име и фамилия: минимум 2 символа
- Телефон: валиден български формат
- Email: валиден формат (ако е попълнен)
- Комисионна: 0-100% (ако е архитект)

### UC2: Създаване на юридическо лице

**Стъпки:**
1. Потребителят избира "Юридическо лице"
2. Въвежда име на фирма (задължително)
3. Въвежда ЕИК/Булстат (задължително, уникално)
4. Опционално: ДДС номер, адрес по регистрация
5. Въвежда телефон за контакт
6. Добавя контактни лица с позиции
7. Преглежда и запазва

**Валидации:**
- ЕИК: 9 или 13 цифри
- ДДС номер: BG + 9 цифри
- Поне едно контактно лице

### UC3: Обработка на дубликати

**Сценарий 1: Точно съвпадение на телефон**
```
Вход: +359888123456
Резултат: Блокиране, показване на съществуващ клиент
Действие: Преглед на съществуващ или промяна на телефон
```

**Сценарий 2: Подобен телефон**
```
Вход: 0888123456 (без +359)
Резултат: Предупреждение, възможност за продължаване
Действие: Потвърждение че е различен клиент
```

**Сценарий 3: Подобно име**
```
Вход: "Иван Петровв" (съществува "Иван Петров")
Резултат: Предложение за проверка
Действие: Показване на подобни клиенти
```

## Бизнес правила

### 1. Уникалност
- **Телефон**: Абсолютно уникален в системата
- **ЕИК**: Уникален за юридически лица
- **Email**: Може да се дублира (семейства, фирми)

### 2. Контактни лица
- **Минимум**: 1 (автоматично от основните данни)
- **Максимум**: 3
- **Основно лице**: Винаги получава оферти и фактури по подразбиране
- **Права**: Всяко лице може да има различни права

### 3. Архитекти/Дизайнери
- **Комисионна по подразбиране**: 10%
- **Диапазон**: 0-100%
- **Видимост**: Показва се в списъци и оферти
- **Изчисления**: Автоматично при оферти

### 4. История и одит
- **Всяко създаване** се записва с потребител и timestamp
- **IP адрес** и browser информация
- **Начални стойности** се пазят за сравнение

## Технически детайли

### API Calls

**1. Проверка за дубликат**
```javascript
POST /api/clients/check-duplicate
{
  "phone": "+359888123456",
  "email": "test@example.com" // optional
}

Response:
{
  "phone_exists": true,
  "email_exists": false,
  "similar_clients": [
    {
      "id": "uuid",
      "name": "Иван Петров",
      "phone": "+359888123456",
      "similarity_score": 1.0
    }
  ]
}
```

**2. Създаване на клиент**
```javascript
POST /api/clients
{
  "client_type": "individual",
  "first_name": "Петър",
  "last_name": "Петров",
  "phone": "+359899123456",
  "email": "petar@example.com",
  "address": "София, ул. Витоша 15",
  "is_architect": true,
  "commission_percent": 15,
  "notes": "Препоръчан от Иван Иванов",
  "contacts": [
    {
      "name": "Петър Петров",
      "phone": "+359899123456",
      "email": "petar@example.com",
      "receives_offers": true,
      "receives_invoices": true,
      "is_primary": true
    },
    {
      "name": "Мария Петрова",
      "phone": "+359899123457",
      "email": "maria@example.com",
      "position": "Счетоводител",
      "receives_offers": false,
      "receives_invoices": true,
      "is_primary": false
    }
  ]
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "client_number": "CL-2025-0001",
    "created_at": "2025-04-23T10:30:00Z"
  }
}
```

### Валидации (Frontend + Backend)

```javascript
// Телефон валидация
function validateBulgarianPhone(phone) {
  // Remove spaces and special chars
  const cleaned = phone.replace(/[\s\-\(\)]/g, '');
  
  // Check format
  const patterns = [
    /^359[87-9]\d{8}$/,     // International without +
    /^\+359[87-9]\d{8}$/,   // International with +
    /^0[87-9]\d{8}$/        // Local format
  ];
  
  return patterns.some(pattern => pattern.test(cleaned));
}

// ЕИК валидация
function validateEIK(eik) {
  // 9 цифри (ЕИК) или 13 цифри (Булстат)
  return /^\d{9}$/.test(eik) || /^\d{13}$/.test(eik);
}

// Email валидация
function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}
```

### Error Handling

**Дублиран телефон:**
```json
{
  "error": {
    "code": "DUPLICATE_PHONE",
    "message": "Клиент с този телефон вече съществува",
    "field": "phone",
    "existing_client": {
      "id": "uuid",
      "name": "Иван Иванов",
      "link": "/clients/uuid"
    }
  }
}
```

**Невалидни данни:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Невалидни данни",
    "fields": {
      "phone": "Невалиден формат на телефон",
      "eik": "ЕИК трябва да е 9 или 13 цифри"
    }
  }
}
```

## UI/UX препоръки

### 1. Progressive Disclosure
- Показваме само нужните полета
- Фирмени данни - само за юридически лица
- Комисионна - само за архитекти

### 2. Inline Validation
- Проверка на телефон при blur
- Визуална индикация (червено/зелено)
- Helpful error messages

### 3. Smart Defaults
- Комисионна 10% за архитекти
- Основният контакт получава всичко
- Автоматично форматиране на телефони

### 4. Keyboard Navigation
- Tab order логичен
- Enter за следващо поле
- Escape за отказ

## Следващи стъпки

1. **Auto-save draft** - запазване на черновата
2. **Bulk import** - от Excel/CSV
3. **Duplicate merge** - сливане на дубликати
4. **Quick create** - само име и телефон
5. **Templates** - за различни типове клиенти